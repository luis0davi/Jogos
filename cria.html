<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Criar Quiz — Plataforma</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0b1b4d; --bg2:#2b3b87; --card:#0f1430; --accent:#ffd36b; --muted:#bfc6da;
  }
  body{margin:20px;font-family:Inter,system-ui, -apple-system, "Segoe UI", Roboto;color:#fff;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased;}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;max-width:980px;margin:0 auto;border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0 0 8px 0}
  label{display:block;margin-top:12px;color:var(--muted);font-size:13px}
  input[type=text], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
  .row{display:flex;gap:8px}
  .small{flex:1}
  .btn{margin-top:10px;padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(180deg,#2b57f7,#0b3bdf);cursor:pointer;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .qbox{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);margin-top:12px;border:1px solid rgba(255,255,255,0.02)}
  .choices{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .mini{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:8px;margin-top:12px}
  .linkout{margin-top:12px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.2);word-break:break-all}
  .trash{background:#e54a4a}
  @media(max-width:720px){ .row{flex-direction:column} .choices{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="card">
    <h1>Criar Quiz</h1>
    <div class="muted">Crie um quiz público — será salvo na planilha (aba: QUIZZES).</div>

    <label>Título do quiz</label>
    <input id="quizTitle" type="text" placeholder="Ex: Quiz NR-18 — Treinamento" />

    <label>Número de perguntas</label>
    <select id="qCount">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="15">15</option>
      <option value="20">20</option>
    </select>

    <div class="actions">
      <button id="btnMake" class="btn">Gerar formulário</button>
      <div class="muted" style="align-self:center">Preencha perguntas e clique em "Salvar Quiz".</div>
    </div>

    <div id="formArea"></div>

    <div id="resultArea" style="margin-top:14px"></div>
  </div>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbx8qN07FPwIVQvoKfKRkhJ5NQSBbGALjEZy4pVry0ZuZ95USwK1eSw4XdwsY0OlVbUsbA/exec";

/**
 * Faz requisição GET ao Apps Script e devolve o objeto JSON do servidor.
 * Tratamento robusto de erros (network / parse / server error).
 */
async function apiGet(params){
  try{
    // monta query string com encoding cuidadoso (especialmente para o campo quiz)
    const qs = Object.keys(params).map(k => {
      const v = params[k];
      // se for string longa (JSON) encodeURIComponent garante que não quebre a URL
      return encodeURIComponent(k) + '=' + encodeURIComponent(String(v));
    }).join('&');
    const url = SHEET_API_URL + '?' + qs;
    const res = await fetch(url, { method: 'GET', cache: 'no-store' });
    const text = await res.text();
    try{
      const data = JSON.parse(text);
      return data;
    }catch(parseErr){
      // servidor retornou texto não-json — repassa para debug
      return { ok:false, error: 'Resposta não-JSON do servidor', raw: text };
    }
  }catch(networkErr){
    return { ok:false, error: 'Erro de rede: ' + (networkErr.message || networkErr) };
  }
}

/* monta um cartão de pergunta (mesma função sua) */
function makeQuestionCard(qdata = null){
  const idx = document.querySelectorAll('.qcard').length;
  const div = document.createElement('div'); div.className = 'qcard';
  div.innerHTML = `
    <label>Pergunta ${idx+1}</label>
    <input class="q-text" placeholder="Texto da pergunta" value="${qdata?escapeHtml(qdata.q):''}" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <input class="opt" placeholder="A" value="${qdata?escapeHtml(qdata.choices[0]||''):''}" />
      <input class="opt" placeholder="B" value="${qdata?escapeHtml(qdata.choices[1]||''):''}" />
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input class="opt" placeholder="C" value="${qdata?escapeHtml(qdata.choices[2]||''):''}" />
      <input class="opt" placeholder="D" value="${qdata?escapeHtml(qdata.choices[3]||''):''}" />
    </div>
    <div class="q-actions">
      <label class="small muted">Correta:</label>
      <select class="correct">
        <option value="0">A</option>
        <option value="1">B</option>
        <option value="2">C</option>
        <option value="3">D</option>
      </select>
      <button class="small-btn btn-rem">Remover</button>
    </div>
  `;
  setTimeout(()=> {
    if(qdata && typeof qdata.answer === 'number'){
      div.querySelector('.correct').value = String(qdata.answer);
    }
  }, 10);
  div.querySelector('.btn-rem').addEventListener('click', ()=> { div.remove(); refreshQuestionIndices(); });
  return div;
}

function refreshQuestionIndices(){
  document.querySelectorAll('.qcard').forEach((el,i)=>{
    el.querySelector('label').innerText = `Pergunta ${i+1}`;
  });
}

/* handlers dos botões (preservei UX original) */
document.getElementById('btnMake').addEventListener('click', ()=>{
  const n = Number(document.getElementById('numQ').value);
  const wrap = document.getElementById('questionsWrap');
  wrap.innerHTML = '';
  for(let i=0;i<n;i++) wrap.appendChild(makeQuestionCard());
  refreshQuestionIndices();
});
document.getElementById('btnAddQ').addEventListener('click', ()=>{
  document.getElementById('questionsWrap').appendChild(makeQuestionCard());
  refreshQuestionIndices();
});

/* ======= CRIAR QUIZ: versão robusta ======= */
document.getElementById('btnCreate').addEventListener('click', async ()=>{
  const title = document.getElementById('quizTitle').value.trim();
  if(!title) return alert('Informe um título para o quiz.');
  const cards = Array.from(document.querySelectorAll('.qcard'));
  if(cards.length === 0) return alert('Adicione pelo menos 1 pergunta.');

  const questions = cards.map(c=>{
    const q = c.querySelector('.q-text').value.trim();
    const opts = Array.from(c.querySelectorAll('.opt')).map(x=>x.value.trim());
    const ans = Number(c.querySelector('.correct').value);
    return { q, choices: opts, answer: ans };
  });

  // validação básica
  for(let i=0;i<questions.length;i++){
    const qq = questions[i];
    if(!qq.q) return alert('Pergunta ' + (i+1) + ' sem texto.');
    if(qq.choices.some(ch => !ch)) return alert('Todas as alternativas devem estar preenchidas (pergunta ' + (i+1) + ').');
    if(typeof qq.answer !== 'number') return alert('Marque a alternativa correta (pergunta ' + (i+1) + ').');
  }

  // prepara payload (serializa o quiz)
  const quizObj = { title: title, questions: questions };
  const quizJson = JSON.stringify(quizObj);

  // chama o endpoint createQuiz via GET (codificando com encodeURIComponent)
  const payload = {
    action: 'createQuiz',
    title: title,
    quiz: quizJson
  };

  // mostrar status temporário
  const resultBox = document.getElementById('resultBox');
  resultBox.style.display = 'block';
  resultBox.innerHTML = '<div class="muted">Criando quiz, aguarde...</div>';

  const res = await apiGet(payload);

  // tratar respostas
  if(res && res.ok && res.id){
    const id = res.id;
    const base = location.origin + location.pathname.replace(/[^/]+$/, '');
    const link = `${base}jogar.html?quiz=${encodeURIComponent(id)}`;
    resultBox.innerHTML = `<div><strong>Quiz criado!</strong></div>
      <div style="margin-top:8px"><input id="quizLink" value="${link}" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff" /></div>
      <div style="margin-top:8px" class="center">
        <button class="small-btn" id="copyBtn">Copiar link</button>
        <a class="small-btn" href="${link}" target="_blank">Abrir link</a>
      </div>`;
    document.getElementById('copyBtn').addEventListener('click', ()=>{
      document.getElementById('quizLink').select();
      document.execCommand('copy');
      alert('Link copiado');
    });
  } else {
    // mostra erro do servidor se houver
    const errMsg = (res && (res.error || res.raw)) ? String(res.error || res.raw) : 'Erro ao criar quiz. Tente novamente.';
    resultBox.innerHTML = `<div style="color:#ffb3b3"><strong>Erro ao criar quiz:</strong> ${escapeHtml(errMsg)}</div>
      <div class="muted" style="margin-top:8px">Verifique o log do Apps Script e tente novamente.</div>`;
    console.error('createQuiz error response:', res);
  }
});

/* small helper escape */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
</script>

</body>
</html>

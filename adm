<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Quiz NR-18</title>
<style>
  body{font-family:Arial;margin:16px;background:#f6f7fb}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);max-width:900px;margin:auto}
  button{padding:8px 12px;border-radius:8px;border:0;background:#0b63ff;color:#fff;cursor:pointer}
  .muted{color:#666;font-size:13px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
</style>
</head>
<body>
  <div class="card">
    <h2>Admin — Quiz NR-18</h2>
    <div class="muted">Aba: Planilha1 — Limpa ao START</div>
    <div style="margin-top:8px">
      <button id="btnStart">START (limpa planilha e inicia)</button>
      <button id="btnReset">RESET (voltar para aguardando)</button>
    </div>

    <h3 style="margin-top:14px">Status atual</h3>
    <div id="statusDiv" class="muted">carregando...</div>

    <h3 style="margin-top:14px">Players conectados</h3>
    <div id="playersCount" class="muted">0</div>

    <h3 style="margin-top:12px">Leaderboard (ao vivo)</h3>
    <div id="leaderboardDiv">carregando...</div>

    <div style="margin-top:12px" class="muted">O sistema verifica automaticamente se todos os jogadores responderam a pergunta atual — quando todos responderem, avança para a próxima pergunta.</div>
  </div>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwbcsewmkC-G5oUGlKKYupDVMgkv_3XCHkrqN-Vcx_FLD0ckE7p2DMzdzC3jxZ5P6XvHg/exec";
const pollMs = 1500; // frequência de polling

async function api(params){
  const url = SHEET_API_URL + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url);
  return res.json();
}

document.getElementById('btnStart').addEventListener('click', async ()=>{
  if(!confirm('Iniciar jogo e limpar planilha?')) return;
  await api({action:'state_set', op:'start'});
  log('Jogo iniciado.');
});

document.getElementById('btnReset').addEventListener('click', async ()=>{
  if(!confirm('Resetar estado (voltar para aguardando)?')) return;
  await api({action:'state_set', op:'reset'});
  log('Estado resetado.');
});

// helpers
function log(msg){
  document.getElementById('statusDiv').innerText = msg;
}
function renderLeaderboard(lb){
  if(!lb || lb.length===0){
    document.getElementById('leaderboardDiv').innerHTML = '<div class="muted">Sem resultados ainda</div>';
    return;
  }
  let html = '<table><thead><tr><th>#</th><th>Nome</th><th>Pontos</th><th>Acertos</th><th>Tempo total (s)</th></tr></thead><tbody>';
  for(let i=0;i<lb.length;i++){
    const r = lb[i];
    html += `<tr><td>${i+1}</td><td>${r.nome}</td><td>${r.pontos}</td><td>${r.acertos}</td><td>${Math.round(r.tempo_ms/1000)}</td></tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('leaderboardDiv').innerHTML = html;
}

async function refresh(){
  try{
    const s = await api({action:'state_get'});
    const players = await api({action:'getPlayersCount'});
    const lb = await api({action:'leaderboard'});
    document.getElementById('playersCount').innerText = (players.count || 0) + ' jogadores registrados';
    renderLeaderboard(lb.leaderboard || []);
    // status
    if(s && s.status){
      document.getElementById('statusDiv').innerText = `Status: ${s.status} — Pergunta atual: ${s.questionIndex} — Início: ${s.questionStartAt? new Date(s.questionStartAt).toLocaleTimeString(): '-'}`;
      // se status live -> checar se devemos avançar automaticamente
      if(s.status === 'live'){
        // checar quantas respostas na pergunta atual
        const qIdx = s.questionIndex;
        const answersCount = await api({action:'countAnswers', qIdx: qIdx});
        const totalPlayers = players.count || 0;
        if(totalPlayers > 0 && answersCount.count >= totalPlayers){
          // todos responderam -> avançar
          await api({action:'state_set', op:'advance'});
          log('Todos responderam a pergunta ' + qIdx + ' — avançando para próxima.');
        }
      }
    } else {
      document.getElementById('statusDiv').innerText = 'Status: (nenhum)';
    }
  }catch(err){
    console.error(err);
  } finally {
    setTimeout(refresh, pollMs);
  }
}

refresh();
</script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Criar Quiz — Plataforma</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:18px;background:#0b1b4d;color:#fff}
  .container{max-width:980px;margin:0 auto}
  .card{background:linear-gradient(180deg,#0f1730,#12162c);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0 0 8px 0}
  label{display:block;margin-top:12px;color:#dfe8ff;font-weight:600}
  input[type="text"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
  .row{display:flex;gap:8px}
  .small{font-size:13px;color:#bfc6da}
  .btn{margin-top:12px;padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(180deg,#2b57f7,#0b3bdf);cursor:pointer;color:#fff;font-weight:700}
  .muted{color:#9fb0e6;font-size:13px}
  .questions{margin-top:14px;display:flex;flex-direction:column;gap:12px}
  .qcard{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .q-actions{display:flex;gap:8px;margin-top:8px}
  .linkbox{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .danger{background:#ff4d4d;color:#fff;padding:6px;border-radius:8px;border:0}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .hint{font-size:13px;color:#bfc6da}
  .inline{display:inline-block}
  .small-btn{padding:6px 10px;border-radius:8px;border:0;background:rgba(255,255,255,0.04);color:#fff;cursor:pointer}
  .center{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="flex-between">
        <div>
          <h1>Criar novo Quiz</h1>
          <div class="muted">Crie perguntas e gere um link público para jogar.</div>
        </div>
        <div class="small muted">Backend: Google Apps Script</div>
      </div>

      <label>Título do quiz</label>
      <input id="quizTitle" placeholder="Ex: NR-18 - Roteiro 2025" />

      <label>Nº de perguntas</label>
      <select id="numQ">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>

      <div style="margin-top:10px" class="center">
        <button id="btnMake" class="btn">Gerar formulário</button>
        <div class="hint">ou adicione perguntas manualmente abaixo</div>
      </div>

      <div id="questionsWrap" class="questions" style="margin-top:12px"></div>

      <div style="margin-top:10px" class="center">
        <button id="btnAddQ" class="small-btn">+ Adicionar pergunta</button>
        <button id="btnCreate" class="btn">Criar quiz e gerar link</button>
      </div>

      <div id="resultBox" class="linkbox" style="display:none;margin-top:12px"></div>

      <div style="margin-top:12px" class="muted small">O quiz será salvo na aba "QUIZZES" da sua planilha (Apps Script).</div>
    </div>
  </div>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwbcsewmkC-G5oUGlKKYupDVMgkv_3XCHkrqN-Vcx_FLD0ckE7p2DMzdzC3jxZ5P6XvHg/exec";

function api(params){
  const url = SHEET_API_URL + '?' + new URLSearchParams(params).toString();
  return fetch(url, {method:'GET', cache:'no-store'}).then(r=>r.json());
}

function makeQuestionCard(qdata = null){
  const idx = document.querySelectorAll('.qcard').length;
  const div = document.createElement('div'); div.className = 'qcard';
  div.innerHTML = `
    <label>Pergunta ${idx+1}</label>
    <input class="q-text" placeholder="Texto da pergunta" value="${qdata?escapeHtml(qdata.q):''}" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <input class="opt" placeholder="A" value="${qdata?escapeHtml(qdata.choices[0]||''):''}" />
      <input class="opt" placeholder="B" value="${qdata?escapeHtml(qdata.choices[1]||''):''}" />
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input class="opt" placeholder="C" value="${qdata?escapeHtml(qdata.choices[2]||''):''}" />
      <input class="opt" placeholder="D" value="${qdata?escapeHtml(qdata.choices[3]||''):''}" />
    </div>
    <div class="q-actions">
      <label class="small muted">Correta:</label>
      <select class="correct">
        <option value="0">A</option>
        <option value="1">B</option>
        <option value="2">C</option>
        <option value="3">D</option>
      </select>
      <button class="small-btn btn-rem">Remover</button>
    </div>
  `;
  // set correct if qdata
  setTimeout(()=> {
    if(qdata && typeof qdata.answer === 'number'){
      div.querySelector('.correct').value = String(qdata.answer);
    }
  }, 10);

  // remove handler
  div.querySelector('.btn-rem').addEventListener('click', ()=> {
    div.remove();
    refreshQuestionIndices();
  });

  return div;
}

function refreshQuestionIndices(){
  document.querySelectorAll('.qcard').forEach((el,i)=>{
    el.querySelector('label').innerText = `Pergunta ${i+1}`;
  });
}

document.getElementById('btnMake').addEventListener('click', ()=>{
  const n = Number(document.getElementById('numQ').value);
  const wrap = document.getElementById('questionsWrap');
  wrap.innerHTML = '';
  for(let i=0;i<n;i++) wrap.appendChild(makeQuestionCard());
  refreshQuestionIndices();
});

document.getElementById('btnAddQ').addEventListener('click', ()=>{
  document.getElementById('questionsWrap').appendChild(makeQuestionCard());
  refreshQuestionIndices();
});

document.getElementById('btnCreate').addEventListener('click', async ()=>{
  const title = document.getElementById('quizTitle').value.trim();
  if(!title) return alert('Informe um título para o quiz.');
  const cards = Array.from(document.querySelectorAll('.qcard'));
  if(cards.length === 0) return alert('Adicione pelo menos 1 pergunta.');

  const questions = cards.map(c=>{
    const q = c.querySelector('.q-text').value.trim();
    const opts = Array.from(c.querySelectorAll('.opt')).map(x=>x.value.trim());
    const ans = Number(c.querySelector('.correct').value);
    return { q, choices: opts, answer: ans };
  });

  // basic validation
  for(let i=0;i<questions.length;i++){
    const qq = questions[i];
    if(!qq.q) return alert('Pergunta ' + (i+1) + ' sem texto.');
    if(qq.choices.some(ch => !ch)) return alert('Todas as alternativas devem estar preenchidas (pergunta ' + (i+1) + ').');
    if(typeof qq.answer !== 'number') return alert('Marque a alternativa correta (pergunta ' + (i+1) + ').');
  }

  // send to backend (createQuiz)
  try{
    const payload = {
      action: 'createQuiz',
      title: title,
      quiz: JSON.stringify({ title, questions })
    };
    const res = await api(payload);
    if(res && res.ok && res.id){
      const id = res.id;
      const link = `${location.origin}${location.pathname.replace(/[^/]+$/, '')}jogar.html?quiz=${encodeURIComponent(id)}`;
      document.getElementById('resultBox').style.display = 'block';
      document.getElementById('resultBox').innerHTML = `<div><strong>Quiz criado!</strong></div>
        <div style="margin-top:8px"><input id="quizLink" value="${link}" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff" /></div>
        <div style="margin-top:8px" class="center">
          <button class="small-btn" id="copyBtn">Copiar link</button>
          <a class="small-btn" href="${link}" target="_blank">Abrir link</a>
        </div>`;
      document.getElementById('copyBtn').addEventListener('click', ()=>{
        document.getElementById('quizLink').select();
        document.execCommand('copy');
        alert('Link copiado');
      });
    } else {
      alert('Erro ao criar quiz: ' + (res && res.error || 'resposta inesperada'));
    }
  }catch(err){
    console.error(err); alert('Erro na criação: '+ err.message);
  }
});

// helper
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
</script>
</body>
</html>

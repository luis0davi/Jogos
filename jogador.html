<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jogador — Quiz NR-18</title>
<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --primary: #0b63ff;
    --muted: #666;
    --ok: #2ecc71;
    --bad: #e74c3c;
    --choice-bg: #fafafa;
    --choice-border: #e6e6e6;
  }
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;margin:16px;background:var(--bg);color:#111}
  .wrap{max-width:920px;margin:0 auto;display:grid;grid-template-columns:1fr 320px;gap:18px}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 26px rgba(15,20,30,0.06)}
  h2{margin:0 0 8px 0}
  input,button{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px}
  button.primary{background:var(--primary);color:#fff;border:0;cursor:pointer}
  .small{color:var(--muted);font-size:13px}
  .answers button{display:block;margin:10px 0;padding:12px;border-radius:8px;border:1px solid var(--choice-border);background:var(--choice-bg);cursor:pointer;text-align:left;font-size:15px;transition:transform .08s, box-shadow .12s}
  .answers button:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(10,20,40,0.06)}
  .answers button:disabled{opacity:0.7;cursor:not-allowed;transform:none}
  .choice-label{font-weight:700;margin-right:8px}
  .muted{color:var(--muted)}
  .live-rank{font-size:14px}
  .rank-row{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px dashed #eee}
  .status-box{padding:10px;border-radius:8px;background:#fbfbfe;border:1px solid #eff3ff}
  .notice{padding:10px;border-radius:8px;background:#fff7e6;border:1px solid #ffefc6;color:#7a5b00}
  .qtitle{font-size:16px;margin-bottom:8px}
  .feedback{margin-top:8px;font-weight:600}
  .top-badge{background:var(--primary);color:#fff;padding:6px 10px;border-radius:999px;font-size:12px}
  @media(max-width:900px){
    .wrap{grid-template-columns:1fr}
  }
</style>
</head>
<body>

  <div class="wrap">
    <!-- main -->
    <div class="card">
      <h2>Quiz NR-18 — Jogador</h2>

      <div id="introNote" class="status-box" style="margin-bottom:12px">
        <strong>Corrida individual em tempo real</strong> — cada jogador corre sozinho pelas perguntas, sprint total. Respondendo → avança. Ranking atualiza ao vivo, e quem acertar mais rápido assume a liderança.
      </div>

      <div id="stepName">
        <div class="small">Digite seu nome (ou escolha uma sugestão abaixo) — obrigatoriamente antes de iniciar</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="playerName" placeholder="Seu nome" style="flex:1"/>
          <button id="btnReg" class="primary">Registrar</button>
        </div>
        <div style="margin-top:10px">
          <button onclick="document.getElementById('playerName').value='Equipe A'">Equipe A</button>
          <button onclick="document.getElementById('playerName').value='Equipe B'">Equipe B</button>
          <button onclick="document.getElementById('playerName').value='Participante'">Participante</button>
        </div>
      </div>

      <div id="waiting" style="display:none;margin-top:12px">
        <div class="small">Aguardando administrador iniciar o jogo...</div>
        <div style="margin-top:8px">Seu nome: <strong id="showName"></strong></div>
      </div>

      <div id="questionArea" style="display:none;margin-top:12px">
        <div class="qtitle" id="qTitle"></div>
        <div id="qChoices" class="answers" aria-live="polite"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small" id="timeLeft"></div>
          <div class="small feedback" id="feedbackMsg"></div>
        </div>
      </div>

      <div id="endArea" style="display:none;margin-top:12px">
        <div><strong>Jogo finalizado</strong></div>
        <div class="small">Aguarde o resultado no painel do administrador.</div>
      </div>
    </div>

    <!-- side: ranking -->
    <div class="card">
      <h3>Leaderboard (Ao vivo)</h3>
      <div class="small">Top 5 — atualiza automaticamente</div>
      <div id="leaderboard" style="margin-top:12px" class="live-rank">
        <div class="muted">Carregando...</div>
      </div>
      <div style="margin-top:12px" class="notice">
        Dica: responda rápido e acerte para subir no ranking.
      </div>
    </div>
  </div>

<script>
/* Config */
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwbcsewmkC-G5oUGlKKYupDVMgkv_3XCHkrqN-Vcx_FLD0ckE7p2DMzdzC3jxZ5P6XvHg/exec";
const POLL_MS = 1400;
const QUESTION_TIME_LIMIT = 20; // seconds

/* Estado local */
let playerName = null;
let currentQ = 0;
let questionStartAt = null;
let answeredFor = {};      // qIdx -> true
let pollTimer = null;
let rankTimer = null;
let windowQTimer = null;

/* Perguntas (15 NR-18) */
const questions = [
  { q: "Qual o objetivo principal da NR-18?", choices: ["Regulamentar o uso de EPIs","Estabelecer diretrizes de segurança para a indústria da construção","Definir normas de transporte rodoviário","Normatizar uso de produtos químicos"], answer: 1 },
  { q: "Quem é responsável por elaborar o PCMAT?", choices:["O empregador/contratante","O empregado","O sindicato","O cliente da obra"], answer: 0 },
  { q: "A NR-18 exige projeto de proteção coletiva para andaimes. Verdadeiro ou falso?", choices:["Verdadeiro","Falso","Apenas para andaimes móveis","Apenas para andaimes fixos"], answer: 0 },
  { q: "Medida exigida para movimentação de materiais em altura?", choices:["Uso de escadas domésticas","Transporte manual sem proteção","Plataformas e dispositivos específicos","Somente força humana"], answer: 2 },
  { q: "O responsável deve garantir alimentação e descanso para trabalhadores?", choices:["Sim","Não","Apenas em obras grandes","Apenas em regiões urbanas"], answer: 0 },
  { q: "A NR-18 trata de prevenção de incêndio na obra?", choices:["Sim","Não","Somente industrial","Apenas dormitórios"], answer: 0 },
  { q: "Instalações elétricas provisórias requerem proteção adequada?", choices:["Sim","Não","Apenas em obra grande","Somente >220V"], answer: 0 },
  { q: "A comunicação de riscos e sinalização é exigida?", choices:["Sim","Não","Apenas para riscos químicos","Apenas quando houver acidente"], answer: 0 },
  { q: "A NR-18 exige proteção contra quedas para trabalhos em altura?", choices:["Verdadeiro","Falso","Apenas para alturas > 5m","Apenas com andaimes"], answer: 0 },
  { q: "Alojamentos devem possuir condições higiênicas e sanitárias?", choices:["Sim","Não","Apenas para estrangeiros","Somente em canteiros isolados"], answer: 0 },
  { q: "Formação e treinamento dos trabalhadores é exigida?", choices:["Sim","Não","Apenas para supervisores","Apenas para operadores"], answer: 0 },
  { q: "NR-18 aborda medidas para escavações?", choices:["Sim","Não","Somente >2m","Apenas solo instável"], answer: 0 },
  { q: "O uso de EPI substitui medidas coletivas?", choices:["Não, coletivas priorizadas","Sim, EPI basta","Apenas se custo for alto","Somente quando autorizado"], answer: 0 },
  { q: "Áreas de circulação devem ser protegidas e sinalizadas?", choices:["Sim","Não","Apenas >50 trabalhadores","Somente se houver veículos"], answer: 0 },
  { q: "PCMAT é exigido para obras com quantos trabalhadores (NR-18)?", choices:["Obras com 20 trabalhadores ou mais","Obras com 50 trabalhadores ou mais","Todas as obras","Apenas obras públicas"], answer: 0 }
];

/* util */
function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}
async function api(params){
  const url = SHEET_API_URL + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url);
  return res.json();
}

/* ranking */
async function refreshRanking(){
  try{
    const data = await api({action:'leaderboard'});
    const lb = (data && data.leaderboard) ? data.leaderboard : [];
    renderLeaderboard(lb.slice(0,5));
  }catch(err){
    console.error(err);
  }
}
function startRankPolling(){
  refreshRanking();
  if(rankTimer) clearInterval(rankTimer);
  rankTimer = setInterval(refreshRanking, POLL_MS);
}
function renderLeaderboard(list){
  const box = document.getElementById('leaderboard');
  if(!list || list.length === 0){
    box.innerHTML = '<div class="muted">Sem resultados ainda</div>';
    return;
  }
  let html = '';
  for(let i=0;i<list.length;i++){
    const r = list[i];
    html += `<div class="rank-row"><div><strong>#${i+1} ${escapeHtml(r.nome)}</strong><div class="muted">acertos: ${r.acertos || 0}</div></div><div><strong>${r.pontos || 0}</strong></div></div>`;
  }
  box.innerHTML = html;
}

/* register */
document.getElementById('btnReg').addEventListener('click', async ()=>{
  const v = document.getElementById('playerName').value.trim();
  if(!v) return alert('Digite um nome');
  playerName = v;
  await api({action:'register', nome: playerName});
  document.getElementById('showName').innerText = playerName;
  document.getElementById('stepName').style.display = 'none';
  document.getElementById('waiting').style.display = 'block';
  startPolling();
  startRankPolling();
});

/* polling global to detect START */
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try{
      const state = await api({action:'state_get'});
      if(!state || !state.status || state.status === 'waiting'){
        document.getElementById('waiting').style.display = 'block';
        document.getElementById('questionArea').style.display = 'none';
        return;
      }
      if(state.status === 'live'){
        if(typeof currentQ !== 'number' || currentQ < 0) currentQ = 0;
        if(answeredFor[currentQ]){
          document.getElementById('waiting').style.display = 'block';
          document.getElementById('questionArea').style.display = 'none';
        } else {
          showQuestionLocal(currentQ);
        }
      } else if(state.status === 'finished'){
        document.getElementById('waiting').style.display = 'none';
        document.getElementById('questionArea').style.display = 'none';
        document.getElementById('endArea').style.display = 'block';
        clearInterval(pollTimer);
      }
    }catch(err){
      console.error(err);
    }
  }, POLL_MS);
}

/* show question (with shuffled choices) */
function showQuestionLocal(qIdx){
  const q = questions[qIdx];
  if(!q){
    document.getElementById('questionArea').style.display = 'none';
    document.getElementById('waiting').style.display = 'none';
    document.getElementById('endArea').style.display = 'block';
    return;
  }

  // render
  document.getElementById('waiting').style.display = 'none';
  document.getElementById('endArea').style.display = 'none';
  document.getElementById('questionArea').style.display = 'block';
  document.getElementById('qTitle').innerText = `Pergunta ${qIdx+1}: ${q.q}`;
  const choicesDiv = document.getElementById('qChoices');
  choicesDiv.innerHTML = '';
  document.getElementById('feedbackMsg').innerText = '';

  // build shuffled choices with mapping to original index
  const pairs = q.choices.map((text, idx) => ({text, origIdx: idx}));
  shuffleArray(pairs);
  // locate which shuffled index holds the correct origin
  let shuffledCorrectIndex = pairs.findIndex(p => p.origIdx === q.answer);

  // start timer
  questionStartAt = Date.now();

  // create buttons
  pairs.forEach((p, i)=>{
    const btn = document.createElement('button');
    btn.innerHTML = `<span class="choice-label">${String.fromCharCode(65+i)}</span>${escapeHtml(p.text)}`;
    // pass the shuffled index and resolved correctness check using origIdx
    btn.onclick = () => handleChoiceClick(btn, qIdx, p.origIdx, i, shuffledCorrectIndex);
    choicesDiv.appendChild(btn);
  });

  // clear old timer and start visual countdown
  if(windowQTimer){ clearInterval(windowQTimer); windowQTimer = null; }
  updateTimeLeft();
  windowQTimer = setInterval(updateTimeLeft, 200);
}

/* updateTimeLeft + timeout handler */
function updateTimeLeft(){
  if(!questionStartAt){
    document.getElementById('timeLeft').innerText = '';
    return;
  }
  const elapsed = (Date.now() - questionStartAt) / 1000; // s
  const left = Math.max(0, Math.ceil(QUESTION_TIME_LIMIT - elapsed));
  document.getElementById('timeLeft').innerText = `Tempo restante: ${left}s`;

  if(left <= 0){
    if(windowQTimer){ clearInterval(windowQTimer); windowQTimer = null; }
    handleTimeout();
  }
}

async function handleTimeout(){
  const qIdx = currentQ;
  if(!Number.isInteger(qIdx)) return;
  if(answeredFor[qIdx]) return;

  // disable buttons
  const choiceButtons = document.querySelectorAll('#qChoices button');
  choiceButtons.forEach(b => b.disabled = true);

  answeredFor[qIdx] = true;

  // record timeout as error, tempo igual ao limite
  const timeSpent = QUESTION_TIME_LIMIT * 1000;
  const pontos = 0;
  try{
    await api({
      action:'submit',
      nome: playerName,
      qIdx: qIdx,
      acertos: 0,
      tempo: timeSpent,
      pontos: pontos
    });
  }catch(err){
    console.error('Erro ao submeter timeout:', err);
  }

  document.getElementById('feedbackMsg').innerText = 'Tempo esgotado — erro.';
  setTimeout(()=>{
    currentQ = qIdx + 1;
    showQuestionLocal(currentQ);
    refreshRanking();
  }, 700);
}

/* handle click: origChoiceIdx = original index of clicked choice; shuffledIdx = visual position; shuffledCorrectIndex = visual pos of correct */
async function handleChoiceClick(btn, qIdx, origChoiceIdx, shuffledIdx, shuffledCorrectIndex){
  // prevent multiple clicks
  const choiceButtons = document.querySelectorAll('#qChoices button');
  choiceButtons.forEach(b=> b.disabled = true);

  // compute times
  const at = Date.now();
  const timeSpent = Math.max(0, at - questionStartAt); // ms
  const timeSpentSec = timeSpent / 1000;
  const timeLeft = Math.max(0, QUESTION_TIME_LIMIT - timeSpentSec);

  // determine correctness (compare origChoiceIdx to question.answer)
  const q = questions[qIdx];
  const correct = (origChoiceIdx === q.answer) ? 1 : 0;
  let pontos = 0;

  if(correct){
    if(timeLeft <= 0){
      pontos = 1 * 0.5;
    } else if(timeLeft > 10){
      pontos = 1 * 1.5;
    } else {
      pontos = 1;
    }
  } else {
    if(timeLeft >= 15 && timeLeft <= 20){
      pontos = -2;
    } else {
      pontos = 0;
    }
  }

  // visual feedback: color clicked + highlight correct
  choiceButtons.forEach((b, idx)=>{
    // idx is shuffled visual index (A,B,C...)
    if(idx === shuffledIdx){
      b.style.borderColor = correct ? 'rgba(46,204,113,0.9)' : 'rgba(231,76,60,0.9)';
      b.style.background = correct ? 'linear-gradient(90deg, rgba(46,204,113,0.12), rgba(46,204,113,0.06))' : 'linear-gradient(90deg, rgba(231,76,60,0.08), rgba(231,76,60,0.03))';
      b.style.boxShadow = '0 8px 20px rgba(0,0,0,0.05)';
    }
    if(idx === shuffledCorrectIndex){
      b.style.borderColor = 'rgba(46,204,113,0.9)';
      b.style.background = 'linear-gradient(90deg, rgba(46,204,113,0.06), rgba(46,204,113,0.02))';
    }
  });

  // send to server
  try{
    await api({
      action:'submit',
      nome: playerName,
      qIdx: qIdx,
      acertos: correct,
      tempo: timeSpent,
      pontos: pontos
    });
  }catch(err){
    console.error('Erro ao submeter resposta:', err);
  }

  answeredFor[qIdx] = true;
  document.getElementById('feedbackMsg').innerText = correct ? `Acertou +${pontos} pts` : (pontos < 0 ? `Errou (${pontos} pts)` : 'Errou (0 pts)');

  // stop visual timer
  if(windowQTimer){ clearInterval(windowQTimer); windowQTimer = null; }

  // advance
  setTimeout(()=> {
    currentQ = qIdx + 1;
    showQuestionLocal(currentQ);
    refreshRanking();
  }, 700);
}

/* cleanup */
window.addEventListener('beforeunload', ()=>{
  if(pollTimer) clearInterval(pollTimer);
  if(rankTimer) clearInterval(rankTimer);
  if(windowQTimer) clearInterval(windowQTimer);
});
</script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî Quiz NR-18 (Leaderboard Estilo Game)</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
  :root{
    --bg1:#0b1b4d;
    --bg2:#2b3b87;
    --card:#0f1430;
    --accent:#ffd36b;
    --muted:#bfc6da;
    --btnStart:#28a745;
    --btnWait:#ff9800;
    --glass: rgba(255,255,255,0.04);
  }
  html,body{height:100%}
  body{
    margin:20px;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(45,60,120,0.15), transparent 8%),
                radial-gradient(1000px 500px at 90% 90%, rgba(30,20,80,0.16), transparent 8%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
    -webkit-font-smoothing:antialiased;color:#fff;
  }
  .card{
    max-width:1100px;margin:0 auto;padding:18px;border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    box-shadow: 0 18px 60px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  h1{margin:0;font-size:20px;letter-spacing:0.6px}
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
  .controls{display:flex;gap:10px;align-items:center;margin-top:12px}

  /* BOT√ïES PERSONALIZADOS */
  button{
    cursor:pointer;
    border:0;
    padding:12px 18px;
    border-radius:12px;
    font-weight:700;
    font-size:14px;
    letter-spacing:0.4px;
    transition:0.25s;
  }
  .btnStart{
    background:linear-gradient(180deg, #3cd65b, #1faa3f);
    color:#fff;
    box-shadow:0 8px 25px rgba(50,255,100,0.25);
  }
  .btnStart:hover{transform:translateY(-2px); box-shadow:0 12px 30px rgba(50,255,100,0.35);}
  
  .btnWait{
    background:linear-gradient(180deg, #ffc46b, #ff9800);
    color:#2a1b00;
    box-shadow:0 8px 25px rgba(255,172,60,0.25);
  }
  .btnWait:hover{transform:translateY(-2px); box-shadow:0 12px 32px rgba(255,172,60,0.35);}
  
  .pill{
    background:rgba(255,255,255,0.03);
    padding:6px 10px;
    border-radius:999px;
    font-weight:600;
    color:var(--muted);
    margin-left:auto
  }

  /* layout leaderboard */
  .board-wrap{display:flex;gap:18px;margin-top:16px;align-items:flex-start}
  .center-stage{
    flex:0 0 440px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:18px; text-align:center; position:relative;
    border:1px solid rgba(255,255,255,0.03);
  }

  .center-stage:before{
    content:"";position:absolute;left:50%;top:10%;width:700px;height:700px;transform:translateX(-50%);
    background:
      radial-gradient(circle at 50% 40%, rgba(255,214,107,0.06) 0%, transparent 20%),
      conic-gradient(rgba(255,214,107,0.06), transparent 10deg, rgba(255,214,107,0.03));
    filter: blur(18px);pointer-events:none;z-index:0;
  }

  .podium{position:relative; z-index:2;}
  .top1 {
    width:180px;margin:0 auto;border-radius:14px;padding:12px;background:linear-gradient(180deg,#1b143a,#2a1b54);
    box-shadow: 0 8px 30px rgba(59,30,100,0.45); border:1px solid rgba(255,200,80,0.09);
  }
  .avatar-circle{
    width:110px;height:110px;border-radius:999px;background:linear-gradient(135deg,#ffd36b,#ffb84d);
    display:inline-flex;align-items:center;justify-content:center;font-weight:800;color:#2a1600;font-size:34px;
    box-shadow:0 8px 26px rgba(255,170,50,0.18), inset 0 -6px 18px rgba(0,0,0,0.2);
  }
  .trophy{
    margin-top:8px;font-weight:800;color:var(--accent);display:flex;align-items:center;justify-content:center;gap:8px;
  }
  .score-big{font-weight:800;font-size:22px;margin-top:8px;color:#fff}

  .side-slot{flex:1 1 200px;display:flex;flex-direction:column;gap:10px}
  .small-top{
    display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border:1px solid rgba(255,255,255,0.02);
  }

  .list{
    flex:1;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);
    max-height:430px; overflow:auto;
  }

</style>
</head>
<body>

  <canvas id="fireCanvas" style="position:fixed;left:0;top:0;pointer-events:none;width:100%;height:100%;z-index:9999"></canvas>

  <div class="card" role="main" aria-live="polite">
    <div style="display:flex;align-items:center;gap:12px">
      <h1>Admin ‚Äî Quiz NR-18</h1>
      <div class="muted">Leaderboard estilo game ‚Äî Top 13</div>
    </div>

    <div class="controls">

      <!-- REMOVIDO o bot√£o Start Perguntas -->

      <button id="btnStart" class="btnStart">Iniciar Jogo (limpa tudo)</button>
      <button id="btnReset" class="btnWait">Aguardar jogadores entrarem</button>

      <div class="pill" id="pollPill">Polling: ON</div>
    </div>

    <div class="muted" id="statusDiv">carregando...</div>

    <!-- RESTANTE DO SEU C√ìDIGO (LEADERBOARD, FIREWORKS, POLLING‚Ä¶) -->

    
    <div class="board-wrap" style="margin-top:14px">
      <!-- LEFT slot (2¬∫ place) -->
      <div class="side-slot" style="align-items:flex-end">
        <div id="slot2" class="small-top fade-in" style="min-width:200px">
          <div class="small-avatar" id="avatar2">2</div>
          <div style="text-align:left">
            <div class="place-badge">2¬∫</div>
            <div id="name2" class="muted">Player</div>
            <div id="score2" class="muted-xs">0 pts ‚Ä¢ 0 acertos</div>
          </div>
        </div>
      </div>

      <!-- CENTER slot (1¬∫ place) -->
      <div class="center-stage">
        <div class="podium">
          <div class="top1 fade-in" id="slot1">
            <div class="avatar-circle" id="avatar1">1</div>
            <div class="trophy">üèÜ <span id="title1" style="opacity:0.9;margin-left:6px">L√≠der</span></div>
            <div class="score-big" id="score1">0</div>
          </div>
        </div>
      </div>

      <!-- RIGHT slot (3¬∫ place) -->
      <div class="side-slot" style="align-items:flex-start">
        <div id="slot3" class="small-top fade-in" style="min-width:200px">
          <div class="small-avatar" id="avatar3">3</div>
          <div style="text-align:left">
            <div class="place-badge">3¬∫</div>
            <div id="name3" class="muted">Player</div>
            <div id="score3" class="muted-xs">0 pts ‚Ä¢ 0 acertos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- List 4..13 -->
    <div class="list" id="listBox" aria-live="polite" style="margin-top:14px">
      <div class="muted" style="padding:6px">Carregando lista...</div>
    </div>
  </div>

<script>
/* ========== Config ========== */
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwbcsewmkC-G5oUGlKKYupDVMgkv_3XCHkrqN-Vcx_FLD0ckE7p2DMzdzC3jxZ5P6XvHg/exec";
const POLL_MS = 300;
const MAX_SHOW = 13;
let pollTimer = null;
let lastLB = [];
let particles = [];
let fireCanvas = document.getElementById('fireCanvas');
let fctx = fireCanvas.getContext('2d');
function resizeCanvas(){ fireCanvas.width = window.innerWidth; fireCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* ========== Helpers API ========== */
async function api(params){
  const url = SHEET_API_URL + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, {cache:'no-store'});
  return res.json();
}

/* ========== UI control buttons ========== */
document.getElementById('btnStartQuestions').addEventListener('click', async ()=>{
  if(!confirm('Iniciar sequ√™ncia de perguntas sem apagar a planilha?')) return;
  try{
    await api({action:'state_set', op:'start_questions'}); // adapte se necess√°rio
    status('Iniciado: perguntas (sem limpar)');
  }catch(e){ console.error(e); status('Erro: '+ (e.message || e)); }
});
document.getElementById('btnStart').addEventListener('click', async ()=>{
  if(!confirm('Iniciar jogo e limpar planilha?')) return;
  await api({action:'state_set', op:'start'});
  status('Iniciado (planilha limpa).');
});
document.getElementById('btnReset').addEventListener('click', async ()=>{
  if(!confirm('Resetar estado (aguardando)?')) return;
  await api({action:'state_set', op:'reset'});
  status('Resetado.');
});
function status(msg){ document.getElementById('statusDiv').innerText = msg; }

/* ========== Render leaderboard (styled like image) ========== */
function formatRow(r){ return { nome: String(r.nome||'Player'), pontos: Number(r.pontos||0), acertos: Number(r.acertos||0), tempo_ms: Number(r.tempo_ms||0) }; }

function render(lb){
  lb = lb.slice(0, MAX_SHOW);
  // sort already assumed from server; ensure shape
  const list = lb.map(formatRow);

  // top 1,2,3
  const top1 = list[0] || null;
  const top2 = list[1] || null;
  const top3 = list[2] || null;

  // update center/top UI
  updateTopUI(top1, top2, top3);

  // update list 4..13
  const rest = list.slice(3);
  renderList(rest);

  // detect changes: who moved positions
  detectPositionChanges(list);
}

/* update top UI nodes */
function updateTopUI(t1, t2, t3){
  // top1
  const avatar1 = document.getElementById('avatar1');
  const title1 = document.getElementById('title1');
  const score1 = document.getElementById('score1');
  const slot1 = document.getElementById('slot1');
  if(t1){
    avatar1.innerText = getInitials(t1.nome);
    title1.innerText = t1.nome;
    score1.innerText = t1.pontos.toLocaleString(undefined,{maximumFractionDigits:2});
    slot1.classList.add('show','glow');
  } else {
    avatar1.innerText = '1';
    title1.innerText = '‚Äî';
    score1.innerText = '0';
    slot1.classList.remove('show','glow');
  }

  // top2
  const avatar2 = document.getElementById('avatar2');
  const name2 = document.getElementById('name2');
  const score2 = document.getElementById('score2');
  const slot2 = document.getElementById('slot2');
  if(t2){
    avatar2.innerText = getInitials(t2.nome);
    name2.innerText = t2.nome;
    score2.innerText = `${t2.pontos.toLocaleString(undefined,{maximumFractionDigits:2})} ‚Ä¢ ${t2.acertos} acertos`;
    slot2.classList.add('show');
  } else {
    avatar2.innerText = '2';
    name2.innerText = '‚Äî';
    score2.innerText = `0 ‚Ä¢ 0 acertos`;
    slot2.classList.remove('show');
  }

  // top3
  const avatar3 = document.getElementById('avatar3');
  const name3 = document.getElementById('name3');
  const score3 = document.getElementById('score3');
  const slot3 = document.getElementById('slot3');
  if(t3){
    avatar3.innerText = getInitials(t3.nome);
    name3.innerText = t3.nome;
    score3.innerText = `${t3.pontos.toLocaleString(undefined,{maximumFractionDigits:2})} ‚Ä¢ ${t3.acertos} acertos`;
    slot3.classList.add('show');
  } else {
    avatar3.innerText = '3';
    name3.innerText = '‚Äî';
    score3.innerText = `0 ‚Ä¢ 0 acertos`;
    slot3.classList.remove('show');
  }
}

/* list render */
function renderList(rows){
  const box = document.getElementById('listBox');
  if(!rows || rows.length===0){
    box.innerHTML = `<div class="muted" style="padding:6px">Sem mais jogadores</div>`;
    return;
  }
  box.innerHTML = rows.map((r, idx)=>{
    const pos = idx + 4;
    return `<div class="row fade-in" data-nome="${escapeHtml(r.nome)}" data-pos="${pos}">
      <div class="num">${pos}</div>
      <div class="name">${escapeHtml(r.nome)}</div>
      <div class="points">${r.pontos.toLocaleString(undefined,{maximumFractionDigits:2})}</div>
      <div class="hits">${r.acertos}</div>
      <div class="timecol">${Math.round(r.tempo_ms/1000)}s</div>
    </div>`;
  }).join('');

  // reveal with small stagger
  requestAnimationFrame(()=> {
    box.querySelectorAll('.fade-in').forEach((el,i)=>{
      setTimeout(()=>el.classList.add('show'), i * 35);
    });
  });
}

/* detect changes and fireworks when someone becomes first */
function detectPositionChanges(list){
  // list: array {nome, pontos, ...}
  // Compare with lastLB by nome
  list = list || [];
  if(lastLB.length === 0){
    lastLB = list.map((r,i)=>({nome:r.nome,pos:i,pontos:r.pontos}));
    return;
  }
  // find who moved to pos 0
  const prevFirst = lastLB[0] ? lastLB[0].nome : null;
  const newFirst = list[0] ? list[0].nome : null;

  // detect any individual position changes -> flash row in list
  const changed = [];
  for(let i=0;i<list.length;i++){
    const name = list[i].nome;
    const prevIndex = lastLB.findIndex(x=>x.nome===name);
    if(prevIndex !== -1 && prevIndex !== i){
      changed.push({name, from:prevIndex, to:i});
    }
  }

  // apply flash to changed items (top 1 handled separately)
  changed.forEach(c=>{
    // if changed item is among 4..13, flash its row
    const pos = c.to;
    if(pos >= 3){
      const rows = document.querySelectorAll('#listBox .row');
      const idx = pos - 3; // 0-based in listBox
      const el = rows[idx];
      if(el){
        el.classList.add('flash');
        setTimeout(()=>el.classList.remove('flash'), 1100);
      }
    }
  });

  if(prevFirst !== newFirst && newFirst){
    // highlight top1 box and fireworks
    const slot1 = document.getElementById('slot1');
    slot1.classList.add('flash');
    setTimeout(()=>slot1.classList.remove('flash'),1200);
    // burst fireworks
    fireBurst();
  }

  lastLB = list.map((r,i)=>({nome:r.nome,pos:i,pontos:r.pontos}));
}

/* tiny utils */
function escapeHtml(s=''){ return String(s).replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[c])); }
function getInitials(name='Player'){ const parts = name.trim().split(/\s+/); if(parts.length===1) return parts[0].slice(0,2).toUpperCase(); return (parts[0][0]+(parts[1]||'')[0]).toUpperCase(); }

/* ========== Polling logic ========== */
async function pollOnce(){
  try{
    const [sRes, pRes, lbRes] = await Promise.all([
      api({action:'state_get'}),
      api({action:'getPlayersCount'}),
      api({action:'leaderboard'})
    ]);

    const playersCount = (pRes && pRes.count) ? pRes.count : 0;
    document.getElementById('pollPill').innerText = `Polling: ON ‚Ä¢ ${playersCount} jogadores`;

    const lbList = (lbRes && lbRes.leaderboard) ? lbRes.leaderboard : [];
    render(lbList.slice(0, MAX_SHOW));

    if(sRes && sRes.status){
      document.getElementById('statusDiv').innerText = `Status: ${sRes.status} ‚Äî Pergunta: ${sRes.questionIndex} ‚Äî In√≠cio: ${sRes.questionStartAt ? new Date(sRes.questionStartAt).toLocaleTimeString() : '-'}`;
    } else {
      document.getElementById('statusDiv').innerText = 'Status: (nenhum)';
    }
  }catch(e){
    console.error('poll error', e);
  }
}

function startPolling(){
  stopPolling();
  pollTimer = setInterval(()=>{ if(document.visibilityState==='visible') pollOnce(); }, POLL_MS);
  pollOnce();
}
function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer = null; document.getElementById('pollPill').innerText = 'Polling: OFF'; }

document.addEventListener('visibilitychange', ()=> {
  if(document.visibilityState === 'hidden') stopPolling(); else startPolling();
});

/* ========== Firework / particles ========== */
function fireBurst(){
  // simple burst of golden particles
  const cx = window.innerWidth * 0.5 + (Math.random()-0.5)*200;
  const cy = window.innerHeight * 0.22 + (Math.random()-0.5)*60;
  const count = 28 + Math.floor(Math.random()*20);
  for(let i=0;i<count;i++){
    particles.push({
      x: cx, y: cy,
      vx: (Math.random()-0.5) * (4 + Math.random()*6),
      vy: (Math.random()-0.8) * (6 + Math.random()*6) * -1,
      life: 60 + Math.random()*40,
      size: 1 + Math.random()*3,
      hue: 40 + Math.random()*28
    });
  }
  if(!animating) { animating = true; requestAnimationFrame(animLoop); }
}

let animating = false;
function animLoop(){
  fctx.clearRect(0,0,fireCanvas.width, fireCanvas.height);
  for(let i = particles.length-1; i>=0; i--){
    const p = particles[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.life -= 1; p.size *= 0.995;
    fctx.beginPath();
    fctx.globalAlpha = Math.max(0, p.life / 80);
    fctx.fillStyle = `hsl(${p.hue}, 90%, ${50 + Math.random()*10}%)`;
    fctx.arc(p.x, p.y, Math.max(0.4, p.size), 0, Math.PI*2);
    fctx.fill();
    if(p.life <= 0 || p.y > fireCanvas.height + 20) particles.splice(i,1);
  }
  if(particles.length>0) requestAnimationFrame(animLoop); else { animating = false; fctx.clearRect(0,0,fireCanvas.width, fireCanvas.height); }
}

/* alias for external */
function fireBurstExternal(){ fireBurst(); }

/* ========== Init ========== */
startPolling();
window.__admin = { startPolling, stopPolling, fireBurst: fireBurstExternal };

/* expose small demo burst after load */
setTimeout(()=>fireBurst(), 900);
</script>
</body>
</html>


<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jogar — Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  /* (mesmo estilo usado antes; resumido) */
  :root{--bg1:#0b1b4d;--bg2:#2b3b87;--accent:#ffd36b;--muted:#bfc6da}
  body{font-family:Inter,system-ui;margin:18px;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eef3ff}
  .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr} }
  .card{padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
  h2{margin:0 0 8px 0}
  input,button,select{font-family:inherit}
  input[type="text"]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:#fff}
  .btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(180deg,#2b57f7,#0b3bdf);color:#fff;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .answers{margin-top:8px;display:flex;flex-direction:column;gap:10px}
  .answers button{display:block;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#fff;text-align:left;font-weight:700}
  .choice-label{display:inline-block;background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;margin-right:12px;font-weight:800}
  .time-box{font-size:16px;font-weight:800;color:var(--accent)}
  .muted-xs{font-size:12px;color:var(--muted)}
  .notice{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted);margin-top:12px}
  .answers button:focus{outline:none;box-shadow:none}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-live="polite">
      <h2 id="quizTitle">Quiz</h2>
      <div id="introNote" class="muted">Carregando quiz...</div>

      <div id="stepName" style="margin-top:12px">
        <div class="muted-xs">Digite seu nome — obrigatório antes de iniciar</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="playerName" placeholder="Seu nome" />
          <button id="btnReg" class="btn">Registrar</button>
        </div>
      </div>

      <div id="waiting" style="display:none;margin-top:12px">
        <div class="muted-xs">Aguardando administrador iniciar o jogo...</div>
        <div style="margin-top:8px">Seu nome: <strong id="showName"></strong></div>
      </div>

      <div id="questionArea" style="display:none;margin-top:12px">
        <div class="qtitle" id="qTitle">Pergunta</div>
        <div id="qChoices" class="answers" aria-live="polite" aria-atomic="true"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="time-box" id="timeLeft">Tempo restante: 20s</div>
          <div class="feedback" id="feedbackMsg" aria-live="polite"></div>
        </div>
      </div>

      <div id="endArea" style="display:none;margin-top:12px">
        <div><strong>Jogo finalizado</strong></div>
        <div class="muted-xs">Aguarde o resultado no painel do administrador.</div>
      </div>
    </div>

    <div class="card" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">Leaderboard (Ao vivo)</h3>
          <div class="muted-xs">Top 10 — atualiza automaticamente</div>
        </div>
        <div class="muted-xs" id="pollPill">Polling: ON</div>
      </div>

      <div id="leaderboard" style="margin-top:12px"></div>
      <div class="notice">Dica: responda rápido e acerte para subir no ranking.</div>
    </div>
  </div>

<script>
/* ========== Config ========== */
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbyCpH634HPl1yg2l5ly9S0GZ1oC1Jn-HV54SiWysyKSCk-VcIIDmDPNDMvkGuQqbdOMjA/exec";
const POLL_MS = 800;
const QUESTION_TIME_LIMIT = 20;

/* ========== Estado ========== */
let playerName = null;
let currentQ = 0;
let questionStartAt = null;
let answeredFor = {};
let pollTimer = null;
let rankTimer = null;
let isQuestionVisible = false;
let questions = []; // será carregado do backend
let quizId = null;

/* ========== util api ========== */
async function api(params){
  const url = SHEET_API_URL + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url);
  return res.json();
}

/* ========== ler id do querystring ========== */
function getQueryParam(name){
  const url = new URL(location.href);
  return url.searchParams.get(name);
}

/* ========== carregar quiz do backend ========== */
async function loadQuiz(){
  const id = getQueryParam('quiz');
  quizId = id;
  if(!id){
    document.getElementById('introNote').innerText = 'Quiz não informado. Use o link correto.';
    return;
  }
  document.getElementById('introNote').innerText = 'Carregando quiz...';
  try{
    const res = await api({ action:'getQuiz', id: id });
    if(res && res.ok && res.quiz){
      const q = res.quiz;
      document.getElementById('quizTitle').innerText = q.title || 'Quiz';
      document.getElementById('introNote').innerText = '';
      // ensure format: questions array of { q, choices[], answer }
      questions = q.questions || [];
    } else {
      document.getElementById('introNote').innerText = 'Quiz não encontrado.';
    }
  }catch(err){
    console.error('Erro getQuiz', err);
    document.getElementById('introNote').innerText = 'Erro ao carregar quiz.';
  }
}

/* ========== registro ========== */
document.getElementById('btnReg').addEventListener('click', async ()=>{
  const v = document.getElementById('playerName').value.trim();
  if(!v) return alert('Digite um nome');
  playerName = v;
  await api({ action:'register', nome: playerName });
  document.getElementById('showName').innerText = playerName;
  document.getElementById('stepName').style.display = 'none';
  document.getElementById('waiting').style.display = 'block';
  startPolling();
  startRankPolling();
});

/* ========== polling do estado (mantive lógica original) ========== */
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try{
      const state = await api({action:'state_get'});
      if(!state || !state.status || state.status === 'waiting'){
        document.getElementById('waiting').style.display = 'block';
        document.getElementById('questionArea').style.display = 'none';
        isQuestionVisible = false;
        return;
      }
      if(state.status === 'live'){
        if(typeof currentQ !== 'number' || currentQ < 0) currentQ = 0;
        if(answeredFor[currentQ]){
          document.getElementById('waiting').style.display = 'block';
          document.getElementById('questionArea').style.display = 'none';
          isQuestionVisible = false;
        } else {
          if(!isQuestionVisible){
            showQuestionLocal(currentQ);
          }
        }
      }
      if(state.status === 'finished'){
        document.getElementById('waiting').style.display = 'none';
        document.getElementById('questionArea').style.display = 'none';
        document.getElementById('endArea').style.display = 'block';
        clearInterval(pollTimer);
      }
    }catch(err){
      console.error('Erro polling estado:', err);
    }
  }, POLL_MS);
}

/* ========== leaderboard (mantive suas funções) ========== */
async function refreshRanking(){
  try{
    const { leaderboard = [] } = await api({ action: 'leaderboard' });
    renderLeaderboard( leaderboard.slice(0, 10) );
  }catch(err){
    console.error('ranking erro:', err);
  }
}

function startRankPolling(){
  clearInterval(rankTimer);
  refreshRanking();
  rankTimer = setInterval(refreshRanking, POLL_MS);
}

function renderLeaderboard(list = []){
  const box = document.getElementById('leaderboard');
  if(list.length === 0){
    box.innerHTML = `<div class="muted">Sem resultados ainda</div>`;
    return;
  }
  box.innerHTML = list.map((r, i) => `
    <div class="rank-row">
      <div>
        <strong>#${i+1} ${escapeHtml(r.nome)}</strong>
        <div class="muted">acertos: ${r.acertos ?? 0}</div>
      </div>
      <strong>${r.pontos ?? 0}</strong>
    </div>
  `).join('');
}

/* ========== showQuestionLocal (carrega de questions[] dinâmico) ========== */
function showQuestionLocal(qIdx){
  const q = questions[qIdx];
  if(!q){
    document.getElementById('questionArea').style.display = 'none';
    document.getElementById('waiting').style.display = 'none';
    document.getElementById('endArea').style.display = 'block';
    isQuestionVisible = false;
    return;
  }

  document.getElementById('waiting').style.display = 'none';
  document.getElementById('endArea').style.display = 'none';
  document.getElementById('questionArea').style.display = 'block';
  document.getElementById('qTitle').innerText = `Pergunta ${qIdx+1}: ${q.q}`;
  const choicesDiv = document.getElementById('qChoices');
  choicesDiv.innerHTML = '';
  document.getElementById('feedbackMsg').innerText = '';

  isQuestionVisible = true;
  questionStartAt = Date.now();

  q.choices.forEach((c,i)=>{
    const btn = document.createElement('button');
    btn.innerHTML = `<span class="choice-label">${String.fromCharCode(65+i)}</span>${escapeHtml(c)}`;
    btn.addEventListener('click', () => handleChoiceClick(btn, qIdx, i), { once: true });
    choicesDiv.appendChild(btn);
  });

  if(window.qTimer){ clearInterval(window.qTimer); window.qTimer = null; }
  updateTimeLeft();
  window.qTimer = setInterval(updateTimeLeft, 200);
}

/* ========== updateTimeLeft / handleTimeout / scoring / handleChoiceClick ==========
   Mantive as funções e lógica original do seu jogo.
   (copiei a lógica de scoring que você definiu)
   ========================================================= */
function updateTimeLeft(){
  if(!questionStartAt){
    document.getElementById('timeLeft').innerText = '';
    return;
  }
  const elapsed = (Date.now() - questionStartAt) / 1000;
  const left = Math.max(0, Math.ceil(QUESTION_TIME_LIMIT - elapsed));
  document.getElementById('timeLeft').innerText = `Tempo restante: ${left}s`;

  if(left <= 0){
    if(window.qTimer){ clearInterval(window.qTimer); window.qTimer = null; }
    handleTimeout();
  }
}

async function handleTimeout(){
  const qIdx = currentQ;
  if(!Number.isInteger(qIdx)) return;
  if(answeredFor[qIdx]) return;

  const choiceButtons = document.querySelectorAll('#qChoices button');
  choiceButtons.forEach(b => b.disabled = true);

  answeredFor[qIdx] = true;

  const timeSpent = QUESTION_TIME_LIMIT * 1000;
  const pontos = 0;
  const correct = 0;

  try{
    await api({
      action: 'submit',
      nome: playerName,
      qIdx: qIdx,
      acertos: correct,
      tempo: timeSpent,
      pontos: pontos,
      quizId: quizId
    });
  }catch(err){
    console.error('Erro ao submeter timeout:', err);
  }

  document.getElementById('feedbackMsg').innerText = 'Tempo esgotado — resposta não registrada.';
  setTimeout(()=>{
    currentQ = qIdx + 1;
    isQuestionVisible = false;
    showQuestionLocal(currentQ);
    refreshRanking();
  }, 700);
}

async function handleChoiceClick(btn, qIdx, choiceIdx){
  const choiceButtons = document.querySelectorAll('#qChoices button');
  choiceButtons.forEach(b=> b.disabled = true);

  const at = Date.now();
  const timeSpent = Math.max(0, at - questionStartAt);   // ms
  const timeSpentSec = timeSpent / 1000;                 // s
  const timeLeft = Math.max(0, QUESTION_TIME_LIMIT - timeSpentSec); // segundos (float)

  const q = questions[qIdx];
  const correct = (choiceIdx === q.answer) ? 1 : 0;

  const maxPontos = 100/15;
  const minPontos = maxPontos/2;
  const punish    = maxPontos/4;
  const t = timeLeft;
  let pontos = 0;

  if (correct) {
    if (t >= 15 && t <= 20) {
      pontos = maxPontos;
    } else {
      const ratio = Math.min(14, Math.max(0, t)) / 14;
      pontos = minPontos + (maxPontos - minPontos) * ratio;
    }
  } else {
    if (t >= 15 && t <= 20) {
      pontos = -punish;
    } else {
      pontos = 0;
    }
  }

  choiceButtons.forEach((b, idx)=>{
    if(idx === choiceIdx){
      b.style.borderColor = correct ? 'rgba(40,167,69,0.95)' : 'rgba(231,76,60,0.95)';
      b.style.background = correct ? 'linear-gradient(90deg, rgba(40,167,69,0.12), rgba(40,167,69,0.04))' : 'linear-gradient(90deg, rgba(231,76,60,0.10), rgba(231,76,60,0.03))';
      b.style.boxShadow = '0 10px 26px rgba(0,0,0,0.06)';
    }
    if(idx === q.answer){
      b.style.borderColor = 'rgba(40,167,69,0.95)';
      b.style.background = 'linear-gradient(90deg, rgba(40,167,69,0.06), rgba(40,167,69,0.02))';
    }
  });

  try{
    await api({
      action:'submit',
      nome: playerName,
      qIdx: qIdx,
      acertos: correct,
      tempo: timeSpent,
      pontos: pontos,
      quizId: quizId
    });
  }catch(err){
    console.error('Erro ao submeter resposta:', err);
  }

  answeredFor[qIdx] = true;
  document.getElementById('feedbackMsg').innerText = correct ? `Acertou +${pontos.toFixed(2)} pts` : (pontos < 0 ? `Errou (${pontos.toFixed(2)} pts)` : 'Errou (0 pts)');

  if(window.qTimer){ clearInterval(window.qTimer); window.qTimer = null; }

  setTimeout(()=> {
    currentQ = qIdx + 1;
    isQuestionVisible = false;
    showQuestionLocal(currentQ);
    refreshRanking();
  }, 650);
}

/* ========== helpers ========== */
function escapeHtml(str){ if(!str && str !== 0) return ''; return String(str).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

/* ========== bootstrap: carregar quiz e iniciar UI ========== */
(async function init(){
  await loadQuiz();
  // nothing else: user must register to play
})();
</script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jogador ‚Äî Quiz NR-18 (Melhorado)</title>

<!-- font -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#071232;
    --bg2:#112254;
    --card: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    --accent:#ffd36b;
    --accent-2:#ffb84d;
    --muted:#bfc6da;
    --glass: rgba(255,255,255,0.03);
    --success: #28a745;
    --danger: #e74c3c;
    --glass-2: rgba(255,255,255,0.02);
  }

  html,body{height:100%}
  body{
    margin:14px;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:#eef3ff;
    background:
      radial-gradient(900px 400px at 12% 12%, rgba(255,214,107,0.03), transparent 6%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    -webkit-font-smoothing:antialiased;
  }

  .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr} }

  .card{
    padding:18px;border-radius:16px;background:var(--card);box-shadow: 0 18px 60px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }

  header.app-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  header.app-head h2{margin:0;font-size:20px;color:#fff}
  header.app-head .sub{color:var(--muted);font-size:13px}

  /* player header */
  .player-bar{display:flex;align-items:center;gap:12px}
  .avatar{
    width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#111;font-size:20px;box-shadow:0 8px 24px rgba(11,99,255,0.06)
  }
  .player-meta{flex:1}
  .player-meta .name{font-weight:800;font-size:16px}
  .player-meta .muted{color:var(--muted);font-size:13px;margin-top:2px}

  .player-stats{display:flex;gap:8px;align-items:center}
  .stat{background:var(--glass);padding:6px 10px;border-radius:10px;font-weight:700;color:var(--muted);font-size:13px}
  .stat strong{display:block;color:#fff;font-size:15px}

  /* controls */
  .controls-row{display:flex;gap:8px;align-items:center;margin-top:10px}
  input[type="text"], input{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;min-width:0}
  .btn{
    cursor:pointer;border:0;padding:10px 14px;border-radius:10px;font-weight:700;background:linear-gradient(180deg,#2b57f7,#0b3bdf);color:#fff;box-shadow:0 8px 30px rgba(11,99,255,0.12)
  }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)}
  .pill{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;font-weight:600;color:var(--muted);margin-left:auto}

  /* question area */
  .qtitle{font-size:18px;margin-bottom:10px;color:#fff}
  .status-box{padding:12px;border-radius:10px;background:var(--glass-2);border:1px solid rgba(255,255,255,0.02);color:var(--muted) }

  .answers{margin-top:8px;display:flex;flex-direction:column;gap:10px}
  .answers button{
    display:block;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    color:#fff;text-align:left;font-size:15px;font-weight:700;
    transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s, background .18s, border-color .18s;
    width:100%;
    box-shadow: 0 6px 24px rgba(2,6,23,0.6);
  }
  .answers button:hover{ transform:translateY(-6px) scale(1.01); box-shadow:0 12px 40px rgba(2,6,23,0.6)}
  .answers button:disabled{opacity:0.9;cursor:not-allowed;transform:none}

  .choice-label{display:inline-block;background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;margin-right:12px;font-weight:800;color:#fff}

  .time-box{font-size:16px;font-weight:800;color:var(--accent)}
  .feedback{font-weight:700;color:#fff}

  /* question images */
  .q-images{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .q-images img{max-width:160px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 30px rgba(2,6,23,0.4)}

  /* right panel */
  .leader-title{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .leader-head{font-size:13px;color:var(--muted);margin-top:8px}
  .rank-row{display:flex;justify-content:space-between;padding:10px;border-radius:10px;margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid rgba(255,255,255,0.02)}
  .rank-row strong{color:#fff}
  .rank-row .muted{color:var(--muted)}

  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;color:#111;background:linear-gradient(90deg,var(--accent),var(--accent-2));font-weight:800}

  .fade-in{opacity:0;transform:translateY(8px);transition:opacity .36s,transform .36s}
  .fade-in.show{opacity:1;transform:none}

  .btn-click{ transform: scale(1.04); box-shadow: 0 18px 40px rgba(255,180,60,0.12); }

  .correct-flash{ animation:flashCorrect 1000ms ease; }
  @keyframes flashCorrect{ 0%{background:rgba(255,245,200,0.95)} 40%{background:rgba(255,245,200,0.4)} 100%{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))} }

  .wrong-flash{ animation:flashWrong 800ms ease; }
  @keyframes flashWrong{ 0%{background:rgba(255,100,100,0.95)} 40%{background:rgba(255,100,100,0.4)} 100%{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))} }

  .muted-xs{font-size:12px;color:var(--muted)}
  .notice{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);color:var(--muted);margin-top:12px}

  @media(max-width:720px){
    .answers button{font-size:14px;padding:12px}
    .wrap{grid-template-columns:1fr}
    .q-images img{max-width:110px}
  }

  .answers button:focus{outline:3px solid rgba(255,214,107,0.18);outline-offset:3px}
  .progress-bar{height:8px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
  .progress-bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
  /* small admin button */
  .admin-row{display:flex;gap:8px;align-items:center;margin-top:12px}
  .admin-row .admin-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer}

  /* modal */
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:10000}
  .modal{background:linear-gradient(180deg,#0e2948,#071a35);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:340px;box-shadow:0 18px 60px rgba(2,6,23,0.7)}
  .modal h4{margin:0 0 8px 0;color:#fff}
  .modal .muted{font-size:13px;color:var(--muted);margin-bottom:12px}
  .modal input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;margin-bottom:12px}
</style>
</head>
<body>

  <canvas id="confettiCanvas" style="position:fixed;left:0;top:0;pointer-events:none;width:100%;height:100%;z-index:9999"></canvas>

  <div class="wrap">
    <!-- MAIN -->
    <div class="card" role="main" aria-live="polite">
      <header class="app-head">
        <h2>Quiz NR-18 ‚Äî Jogador</h2>
        <div class="sub">Interface melhorada ‚Äî Dev: Luis Davi</div>
      </header>

      <!-- player header -->
      <div class="player-bar">
        <div class="avatar" id="avatar">JD</div>
        <div class="player-meta">
          <div class="name" id="playerNameDisplay">Convidado</div>
          <div class="muted">Informe seu nome para participar</div>
          <div style="margin-top:8px" class="progress-bar" title="Progresso">
            <i id="progressFill" style="width:0%"></i>
          </div>
        </div>
        <div class="player-stats">
          <div class="stat">
            <small class="muted-xs">Score</small>
            <strong id="scoreDisplay">0</strong>
          </div>
          <div class="stat">
            <small class="muted-xs">Acertos</small>
            <strong id="hitsDisplay">0</strong>
          </div>
          <div class="stat">
            <small class="muted-xs">Streak</small>
            <strong id="streakDisplay">0</strong>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="status-box">
        <strong id="statusSmall">Pronto para registrar</strong>
        <div class="muted-xs" id="statusSub">Conecte-se e aguarde in√≠cio do jogo.</div>
      </div>

      <!-- registro -->
      <div id="stepName" style="margin-top:12px">
        <div class="muted-xs">Digite seu nome ‚Äî obrigat√≥rio antes de iniciar</div>
        <div class="controls-row" style="margin-top:8px">
          <input id="playerName" placeholder="Seu nome" aria-label="Seu nome" />
          <button id="btnReg" class="btn">Registrar</button>
          <div class="pill" id="playerStatus" style="display:none">Registrado</div>
        </div>

        <div class="admin-row">
          <button id="btnAdmin" class="admin-btn" title="√Årea do administrador">üîí √Årea ADM</button>
          <button id="btnViewSourcePdf" class="admin-btn" title="Abrir PDF da atividade">üìÑ Ver PDF (atividade)</button>
        </div>
      </div>

      <!-- aguardando -->
      <div id="waiting" style="display:none;margin-top:12px">
        <div class="muted-xs">Aguardando administrador iniciar o jogo...</div>
        <div style="margin-top:8px">Seu nome: <strong id="showName"></strong></div>
      </div>

      <!-- pergunta -->
      <div id="questionArea" style="display:none;margin-top:12px">
        <div class="qtitle" id="qTitle">Pergunta</div>
        <div id="qChoices" class="answers" aria-live="polite" aria-atomic="true"></div>

        <div class="q-images" id="qImages" aria-hidden="false"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="time-box" id="timeLeft">Tempo restante: 20s</div>
          <div class="feedback" id="feedbackMsg" aria-live="polite"></div>
        </div>
      </div>

      <!-- final -->
      <div id="endArea" style="display:none;margin-top:12px">
        <div><strong>Jogo finalizado</strong></div>
        <div class="muted-xs">Aguarde o resultado no painel do administrador.</div>
      </div>
    </div>

    <!-- SIDE: RANKING -->
    <div class="card" aria-live="polite">
      <div class="leader-title" style="align-items:center">
        <div>
          <h3 style="margin:0">Leaderboard (Ao vivo)</h3>
          <div class="leader-head muted-xs">Top 10 ‚Äî atualiza automaticamente</div>
        </div>
        <div class="pill" id="pollPill">Polling: ON</div>
      </div>

      <div id="leaderboard" style="margin-top:12px"></div>

      <div class="notice">Dica: responda r√°pido e acerte para subir no ranking.</div>
    </div>
  </div>

  <!-- modal admin -->
  <div id="modalAdmin" style="display:none" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h4>√Årea do Administrador</h4>
      <div class="muted">Digite a senha para abrir a p√°gina de administra√ß√£o.</div>
      <input id="adminPassword" placeholder="Senha" type="password" aria-label="Senha do administrador" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="adminCancel" class="btn ghost">Cancelar</button>
        <button id="adminOk" class="btn">Entrar</button>
      </div>
      <div id="adminMsg" class="muted-xs" style="margin-top:12px;color:var(--muted)"></div>
    </div>
  </div>

<script>
/* ============================================================
   CONFIGURA√á√ïES
   ============================================================ */
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwbcsewmkC-G5oUGlKKYupDVMgkv_3XCHkrqN-Vcx_FLD0ckE7p2DMzdzC3jxZ5P6XvHg/exec";
const POLL_MS = 700;               // frequ√™ncia de polling do estado / ranking
const QUESTION_TIME_LIMIT = 20;     // segundos por pergunta
const ADMIN_PASSWORD = '1029384756';

/* ============================================================
   ESTADO LOCAL
   ============================================================ */
let playerName = null;
let currentQ = 0;
let questionStartAt = null;
let answeredFor = {};
let pollTimer = null;
let rankTimer = null;
let isQuestionVisible = false;
let scoreLocal = 0;
let hitsLocal = 0;
let streakLocal = 0;

/* ============================================================
   PERGUNTAS (inclui imagens da pergunta 9)
   - note: img paths point to files you extracted earlier.
   ============================================================ */
const questions = [
  { q:"O Sol √© uma estrela situada no centro do Sistema Solar. Os planetas giram permanentemente ao redor do Sol. Cada planeta segue um caminho chamado:", 
    choices:["Cometas","√ìrbita","Espa√ßo","Sat√©lites"], 
    answer:1 },

  { q:"Quais s√£o os quatro planetas mais pr√≥ximos do Sol?", 
    choices:["Merc√∫rio, V√™nus, Terra e Marte","Merc√∫rio, Saturno, Netuno e Terra","J√∫piter, Saturno, Urano e Netuno","Urano, Terra, J√∫piter e Marte"], 
    answer:0 },

  { q:"Qual planeta possui um brilho intenso, vis√≠vel da Terra, e √© conhecido como 'Estrela Dalva'?", 
    choices:["V√™nus","Marte","Netuno","Saturno"], 
    answer:0 },

  { q:"Quantos s√£o os planetas do Sistema Solar?", 
    choices:["7","8","9","11"], 
    answer:1 },

  { q:"Os pequenos corpos menores que os planetas an√µes, que orbitam o Sol, s√£o chamados de:", 
    choices:["Asteroides","Sat√©lites","Cometas","Planetas"], 
    answer:0 },

  { q:"O que s√£o sat√©lites naturais?", 
    choices:["Planetas que giram ao redor da Lua","Estrelas que brilham perto da Terra","Meteoros que circulam pelo universo","Astros que orbitam um planeta"], 
    answer:3 },

  { q:"Entre quais planetas est√° localizado o Cintur√£o de Asteroides?", 
    choices:["Entre Merc√∫rio e V√™nus","Entre Terra e Netuno","Entre Marte e J√∫piter","Entre Urano e Terra"], 
    answer:2 },

  { q:"Qual √© o maior planeta do Sistema Solar?", 
    choices:["J√∫piter","Marte","Terra","Saturno"], 
    answer:0 },

  // pergunta 9 com imagens (usei os arquivos extra√≠dos)
  { q:"Assinale a alternativa que mostra a associa√ß√£o correta entre os quadros (veja as imagens):", 
    choices:["I-D, II-B, III-C e IV-A","I-D, II-C, III-A e IV-B","I-A, II-C, III-B e IV-D","I-B, II-D, III-A e IV-C"], 
    answer:0,
    imgs: [
      "/mnt/data/extracted_0_25.png",
      "/mnt/data/extracted_0_26.png",
      "/mnt/data/extracted_0_27.png"
    ] },

  { q:"O trecho: 'Trata-se de uma for√ßa atrativa que surge entre todos os corpos que possuem massa...' refere-se a:", 
    choices:["As estrelas","Os corpos celestes","Os planetas do Sistema Solar","A for√ßa gravitacional"], 
    answer:3 }

];

/* ============================================================
   UTIL: wrapper fetch (API Google Apps Script)
   ============================================================ */
async function api(params){
  try{
    const url = SHEET_API_URL + '?' + new URLSearchParams(params).toString();
    const res = await fetch(url);
    return await res.json();
  }catch(e){
    console.warn('api fetch failed', e);
    return null;
  }
}

/* ============================================================
   √ÅUDIO: WebAudio simple tones (no external files)
   ============================================================ */
const AudioEngine = (function(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  function tone(frequency=440, duration=0.12, type='sine', gain=0.12){
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.value = frequency;
    g.gain.value = gain;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    g.gain.linearRampToValueAtTime(gain, ctx.currentTime + 0.005);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
    o.stop(ctx.currentTime + duration + 0.02);
  }
  return {
    click: ()=> tone(880, 0.06, 'triangle', 0.06),
    correct: ()=> { tone(880,0.06,'sine',0.09); setTimeout(()=>tone(1100,0.12,'sine',0.06),70); },
    wrong: ()=> { tone(220,0.16,'sawtooth',0.12); setTimeout(()=>tone(160,0.12,'sawtooth',0.08),90); }
  };
})();

/* ============================================================
   REGISTRO
   ============================================================ */
document.getElementById('btnReg').addEventListener('click', async ()=>{
  const v = document.getElementById('playerName').value.trim();
  if(!v) return alert('Digite um nome');
  playerName = v;
  // visual local
  updatePlayerHeader();
  document.getElementById('playerStatus').style.display = 'inline-block';
  document.getElementById('stepName').style.display = 'none';
  document.getElementById('waiting').style.display = 'block';
  document.getElementById('showName').innerText = playerName;

  // try register on server (best effort)
  try{ await api({action:'register', nome: playerName}); }catch(e){ console.warn(e); }

  startPolling();
  startRankPolling();
});

/* ============================================================
   Admin modal + redirect with password
   ============================================================ */
const modal = document.getElementById('modalAdmin');
document.getElementById('btnAdmin').addEventListener('click', ()=>{
  document.getElementById('adminPassword').value = '';
  document.getElementById('adminMsg').innerText = '';
  modal.style.display = 'flex';
  document.getElementById('adminPassword').focus();
});
document.getElementById('adminCancel').addEventListener('click', ()=> modal.style.display = 'none');
document.getElementById('adminOk').addEventListener('click', ()=>{
  const v = document.getElementById('adminPassword').value.trim();
  if(v === ADMIN_PASSWORD){
    // success -> redirect to admin page
    modal.style.display = 'none';
    window.location.href = 'https://luis0davi.github.io/Jogos/adm.html';
  } else {
    document.getElementById('adminMsg').innerText = 'Senha incorreta.';
    AudioEngine.wrong();
  }
});
document.getElementById('adminPassword').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') document.getElementById('adminOk').click();
});

/* quick link to uploaded PDF (local path in this environment) */
document.getElementById('btnViewSourcePdf').addEventListener('click', ()=>{
  // developer note: environment will transform this path to an accessible url
  const localPath = '/mnt/data/ATIVIDADE - SISTEMA SOLAR - TUDO SALA DE AULA.pdf';
  // open in new tab (browser may block local file access; your hosting will handle path transform)
  window.open(localPath, '_blank');
});

/* ============================================================
   POLLING DO ESTADO GLOBAL
   ============================================================ */
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try{
      const state = await api({action:'state_get'});
      // adapt to possible responses; fallback to local behavior
      if(!state || !state.status || state.status === 'waiting'){
        document.getElementById('waiting').style.display = 'block';
        document.getElementById('questionArea').style.display = 'none';
        isQuestionVisible = false;
        return;
      }
      if(state.status === 'live'){
        if(typeof currentQ !== 'number' || currentQ < 0) currentQ = 0;
        if(answeredFor[currentQ]) {
          document.getElementById('waiting').style.display = 'block';
          document.getElementById('questionArea').style.display = 'none';
          isQuestionVisible = false;
        } else {
          if(!isQuestionVisible){
            showQuestionLocal(currentQ);
          }
        }
      }
      if(state.status === 'finished'){
        document.getElementById('waiting').style.display = 'none';
        document.getElementById('questionArea').style.display = 'none';
        document.getElementById('endArea').style.display = 'block';
        clearInterval(pollTimer);
      }
    }catch(err){
      console.error('Erro polling estado:', err);
    }
  }, POLL_MS);
}

/* ============================================================
   RANKING AO VIVO
   ============================================================ */
async function refreshRanking(){
  try{
    const res = await api({ action: 'leaderboard' });
    const leaderboard = (res && res.leaderboard) ? res.leaderboard : [];
    renderLeaderboard( leaderboard.slice(0, 10) );
  }catch(err){
    console.error('ranking erro:', err);
  }
}
function startRankPolling(){
  clearInterval(rankTimer);
  refreshRanking();
  rankTimer = setInterval(refreshRanking, POLL_MS);
}
function renderLeaderboard(list = []){
  const box = document.getElementById('leaderboard');
  if(list.length === 0){
    box.innerHTML = `<div class="muted">Sem resultados ainda</div>`;
    return;
  }
  box.innerHTML = list.map((r, i) => `
    <div class="rank-row fade-in">
      <div>
        <strong>#${i+1} ${escapeHtml(r.nome)}</strong>
        <div class="muted">acertos: ${r.acertos ?? 0}</div>
      </div>
      <strong>${r.pontos ?? 0}</strong>
    </div>
  `).join('');
  requestAnimationFrame(()=>{
    document.querySelectorAll('.fade-in').forEach((el,i)=> setTimeout(()=>el.classList.add('show'), i*40));
  });
}

/* ============================================================
   showQuestionLocal(qIdx)
   ============================================================ */
function showQuestionLocal(qIdx){
  const q = questions[qIdx];
  if(!q){
    document.getElementById('questionArea').style.display = 'none';
    document.getElementById('waiting').style.display = 'none';
    document.getElementById('endArea').style.display = 'block';
    isQuestionVisible = false;
    return;
  }

  document.getElementById('waiting').style.display = 'none';
  document.getElementById('endArea').style.display = 'none';
  document.getElementById('questionArea').style.display = 'block';
  document.getElementById('qTitle').innerText = `Pergunta ${qIdx+1}: ${q.q}`;
  const choicesDiv = document.getElementById('qChoices');
  choicesDiv.innerHTML = '';
  document.getElementById('feedbackMsg').innerText = '';

  // render images if present
  const qImgsDiv = document.getElementById('qImages');
  qImgsDiv.innerHTML = '';
  if(q.imgs && Array.isArray(q.imgs) && q.imgs.length){
    q.imgs.forEach(src=>{
      const im = document.createElement('img');
      im.src = src;
      im.alt = 'Imagem da quest√£o';
      qImgsDiv.appendChild(im);
    });
  }

  isQuestionVisible = true;
  questionStartAt = Date.now();

  q.choices.forEach((c,i)=>{
    const btn = document.createElement('button');
    btn.innerHTML = `<span class="choice-label">${String.fromCharCode(65+i)}</span>${escapeHtml(c)}`;
    btn.addEventListener('click', () => handleChoiceClick(btn, qIdx, i), { once: true });
    btn.addEventListener('click', ()=> AudioEngine.click());
    choicesDiv.appendChild(btn);
  });

  // focus first answer for accessibility
  setTimeout(()=> {
    const first = choicesDiv.querySelector('button');
    if(first) first.focus();
  }, 60);

  if(window.qTimer){ clearInterval(window.qTimer); window.qTimer = null; }
  updateTimeLeft();
  window.qTimer = setInterval(updateTimeLeft, 200);
}

/* ============================================================
   updateTimeLeft()
   ============================================================ */
function updateTimeLeft(){
  if(!questionStartAt){
    document.getElementById('timeLeft').innerText = '';
    return;
  }
  const elapsed = (Date.now() - questionStartAt) / 1000;
  const left = Math.max(0, Math.ceil(QUESTION_TIME_LIMIT - elapsed));
  document.getElementById('timeLeft').innerText = `Tempo restante: ${left}s`;

  if(left <= 0){
    if(window.qTimer){ clearInterval(window.qTimer); window.qTimer = null; }
    handleTimeout();
  }
}

/* ============================================================
   handleTimeout()
   ============================================================ */
async function handleTimeout(){
  const qIdx = currentQ;
  if(!Number.isInteger(qIdx)) return;
  if(answeredFor[qIdx]) return;

  const choiceButtons = document.querySelectorAll('#qChoices button');
  choiceButtons.forEach(b => b.disabled = true);

  answeredFor[qIdx] = true;

  const timeSpent = QUESTION_TIME_LIMIT * 1000;
  const pontos = 0;
  const correct = 0;

  try{
    await api({
      action: 'submit',
      nome: playerName,
      qIdx: qIdx,
      acertos: correct,
      tempo: timeSpent,
      pontos: pontos
    });
  }catch(err){
    console.error('Erro ao submeter timeout:', err);
  }

  document.getElementById('feedbackMsg').innerText = 'Tempo esgotado ‚Äî resposta n√£o registrada.';
  AudioEngine.wrong();
  streakLocal = 0;
  updatePlayerHeader();

  setTimeout(()=>{
    currentQ = qIdx + 1;
    isQuestionVisible = false;
    showQuestionLocal(currentQ);
    refreshRanking();
  }, 800);
}

/* ============================================================
   handleChoiceClick(btn, qIdx, choiceIdx)
   ============================================================ */
async function handleChoiceClick(btn, qIdx, choiceIdx){
  const choiceButtons = document.querySelectorAll('#qChoices button');
  choiceButtons.forEach(b=> b.disabled = true);

  const at = Date.now();
  const timeSpent = Math.max(0, at - questionStartAt);   // ms
  const timeSpentSec = timeSpent / 1000;                 // s
  const timeLeft = Math.max(0, QUESTION_TIME_LIMIT - timeSpentSec); // s

  const q = questions[qIdx];
  const correct = (choiceIdx === q.answer) ? 1 : 0;

  // scoring (kept similar logic as original)
  const maxPontos = 110/15;       // ~6.6667
  const minPontos = maxPontos/2;  // ~3.3333
  const punish    = maxPontos/4;  // ~1.6667

  let pontos = 0;
  const t = timeLeft;

  if (correct) {
    if (t >= 15 && t <= 20) {
      pontos = maxPontos;
    } else {
      const ratio = Math.min(14, Math.max(0, t)) / 14;
      pontos = minPontos + (maxPontos - minPontos) * ratio;
    }
  } else {
    if (t >= 15 && t <= 20) {
      pontos = -punish;
    } else {
      pontos = 0;
    }
  }

  // visual highlight
  choiceButtons.forEach((b, idx)=>{
    if(idx === choiceIdx){
      b.style.borderColor = correct ? 'rgba(40,167,69,0.95)' : 'rgba(231,76,60,0.95)';
      b.style.background = correct ? 'linear-gradient(90deg, rgba(40,167,69,0.12), rgba(40,167,69,0.04))' : 'linear-gradient(90deg, rgba(231,76,60,0.10), rgba(231,76,60,0.03))';
      b.style.boxShadow = '0 10px 26px rgba(0,0,0,0.06)';
    }
    if(idx === q.answer){
      b.style.borderColor = 'rgba(40,167,69,0.95)';
      b.style.background = 'linear-gradient(90deg, rgba(40,167,69,0.06), rgba(40,167,69,0.02))';
    }
  });

  // update local stats
  if(correct){
    hitsLocal += 1;
    streakLocal += 1;
    scoreLocal = Math.round((scoreLocal + pontos) * 100)/100;
    AudioEngine.correct();
  } else {
    streakLocal = 0;
    scoreLocal = Math.round((scoreLocal + pontos) * 100)/100;
    AudioEngine.wrong();
  }
  updatePlayerHeader();

  // send to server
  try{
    await api({
      action:'submit',
      nome: playerName,
      qIdx: qIdx,
      acertos: correct,
      tempo: timeSpent,
      pontos: pontos
    });
  }catch(err){
    console.error('Erro ao submeter resposta:', err);
  }

  answeredFor[qIdx] = true;
  document.getElementById('feedbackMsg').innerText = correct ? `Acertou +${pontos.toFixed(2)} pts` : (pontos < 0 ? `Errou (${pontos.toFixed(2)} pts)` : 'Errou (0 pts)');

  if(window.qTimer){ clearInterval(window.qTimer); window.qTimer = null; }

  setTimeout(()=> {
    currentQ = qIdx + 1;
    isQuestionVisible = false;
    showQuestionLocal(currentQ);
    refreshRanking();
  }, 800);
}

/* ============================================================
   UTILIDADES
   ============================================================ */
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

function updatePlayerHeader(){
  const display = document.getElementById('playerNameDisplay');
  display.innerText = playerName || 'Convidado';
  const initials = (playerName || 'Jogador').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
  document.getElementById('avatar').innerText = initials;
  document.getElementById('scoreDisplay').innerText = scoreLocal;
  document.getElementById('hitsDisplay').innerText = hitsLocal;
  document.getElementById('streakDisplay').innerText = streakLocal;
  // progress = percent of quiz answered locally
  const answeredCount = Object.keys(answeredFor).length;
  const total = questions.length;
  const pct = Math.round((answeredCount/total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('statusSmall').innerText = playerName ? 'Registrado' : 'Pronto para registrar';
  document.getElementById('statusSub').innerText = playerName ? `Ol√°, ${playerName}. Aguarde in√≠cio.` : 'Informe seu nome';
}

/* cleanup */
window.addEventListener('beforeunload', ()=>{
  if(pollTimer) clearInterval(pollTimer);
  if(rankTimer) clearInterval(rankTimer);
  if(window.qTimer) clearInterval(window.qTimer);
});

/* small enhancement: animate and confetti on correct events by watching feedback */
const feedbackNode = document.getElementById('feedbackMsg');
if(feedbackNode){
  const obs = new MutationObserver((mutations)=>{
    for(const m of mutations){
      const txt = (m.target && m.target.innerText) ? m.target.innerText.toLowerCase() : '';
      if(txt.startsWith('acertou') || txt.includes('acertou')){
        confettiBurst();
      }
    }
  });
  obs.observe(feedbackNode, { childList: true, subtree: true, characterData: true });
}

/* ---------- lightweight confetti (canvas) ---------- */
const confCanvas = document.getElementById('confettiCanvas');
const cctx = confCanvas.getContext('2d');
let confParticles = [];
let confAnimating = false;
function resizeConf(){ confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeConf);
resizeConf();

function confettiBurst(){
  const cx = window.innerWidth * 0.5;
  const cy = window.innerHeight * 0.28;
  const count = 36 + Math.floor(Math.random()*24);
  for(let i=0;i<count;i++){
    confParticles.push({
      x: cx + (Math.random()-0.5)*240,
      y: cy + (Math.random()-0.5)*80,
      vx: (Math.random()-0.5)*6,
      vy: - (4 + Math.random()*8),
      life: 50 + Math.random()*40,
      size: 4 + Math.random()*6,
      hue: 40 + Math.floor(Math.random()*120),
      rot: Math.random()*360,
      vr: (Math.random()-0.5)*8
    });
  }
  if(!confAnimating){ confAnimating = true; requestAnimationFrame(confLoop); }
}

function confLoop(){
  cctx.clearRect(0,0,confCanvas.width, confCanvas.height);
  for(let i = confParticles.length-1; i >= 0; i--){
    const p = confParticles[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 1; p.vr *= 0.99; p.rot += p.vr;
    cctx.save();
    cctx.translate(p.x, p.y);
    cctx.rotate(p.rot * Math.PI / 180);
    cctx.globalAlpha = Math.max(0, p.life / 80);
    cctx.fillStyle = `hsl(${p.hue}, 85%, ${55 + Math.random()*8}%)`;
    cctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
    cctx.restore();
    if(p.life <= 0 || p.y > confCanvas.height + 40) confParticles.splice(i,1);
  }
  if(confParticles.length > 0) requestAnimationFrame(confLoop); else { confAnimating = false; cctx.clearRect(0,0,confCanvas.width, confCanvas.height); }
}

/* initial update */
updatePlayerHeader();
</script>
</body>
</html>
